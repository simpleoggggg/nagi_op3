name: 16GB Dual VPS Fixed

on:
  repository_dispatch:
    types: [create-vps]
  workflow_dispatch:

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üõë Stop Check
        run: |
          if [ -f "STOP_VPS" ]; then exit 1; fi

      - name: üßπ Maximize Resources
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force
          sudo apt update && sudo apt install -y tmate curl unzip jq

      - name: üìÅ Restore Backup
        run: |
          mkdir -p .backup
          if [ "${{ github.event.client_payload.backup }}" == "true" ]; then
            unzip -o ".backup/autovps.zip" -d . || echo "No backup"
          fi

      - name: üöÄ Start Terminals
        run: |
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          TMATE_SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          
          curl -sSf https://sshx.io/get | sh
          ./sshx > sshx_log.txt 2>&1 &
          
          sleep 12
          SSHX_URL=$(grep -o 'https://sshx.io/s/[^ ]*' sshx_log.txt | head -n 1)
          [ -z "$SSHX_URL" ] && SSHX_URL="‚ö†Ô∏è Timeout"

          echo "TMATE=$TMATE_SSH" >> $GITHUB_ENV
          echo "SSHX=$SSHX_URL" >> $GITHUB_ENV
          echo "RAM=$(free -h | awk '/^Mem:/ {print $2}')" >> $GITHUB_ENV

      - name: üîî Discord Panel
        run: |
          PAYLOAD=$(printf '{"embeds": [{"title": "SYSTEM CONTROL PANEL", "color": 2236962, "description": "VPS: **Active**", "fields": [{"name": "üõ∞Ô∏è CONNECTION", "value": "```%s```"}, {"name": "üåê WEB LINK", "value": "%s"}, {"name": "üìä RAM", "value": "%s", "inline": true}, {"name": "üíæ SAVE", "value": "`pkill sleep`", "inline": true}]}]}' "$TMATE" "$SSHX" "$RAM")
          RESP=$(curl -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "${{ secrets.DISCORD_WEBHOOK }}?wait=true")
          echo "MSG_ID=$(echo $RESP | jq -r '.id')" >> $GITHUB_ENV

      - name: ‚è≥ Keep Alive & Update
        run: |
          (
            while true; do
              sleep 60
              UPTIME=$(uptime -p | sed 's/up //')
              RAM_USED=$(free -m | awk '/Mem:/ {print $3 "MB / " $2 "MB"}')
              
              PAYLOAD=$(printf '{"embeds": [{"title": "LIVE STATUS", "color": 2236962, "fields": [{"name": "üõ∞Ô∏è SSH", "value": "```%s```"}, {"name": "‚è±Ô∏è UPTIME", "value": "%s", "inline": true}, {"name": "üß† RAM", "value": "%s", "inline": true}], "footer": {"text": "Last Sync: %s" } }]}' "$TMATE" "$UPTIME" "$RAM_USED" "$(date +%H:%M:%S)")
              
              curl -X PATCH -H "Content-Type: application/json" -d "$PAYLOAD" "${{ secrets.DISCORD_WEBHOOK }}/messages/${{ env.MSG_ID }}"
            done
          ) & 
          sleep 21000

      - name: üì¶ Final Auto-Backup
        if: always()
        run: |
          zip -ru ".backup/autovps.zip" . -x ".git/*" ".github/*" "sshx_log.txt"
          git config --global user.name "VPS-Backup"
          git config --global user.email "vps@github.com"
          git add .backup/autovps.zip
          git commit -m "Auto-backup [skip ci]" || echo "No changes"
          git push --force
          
