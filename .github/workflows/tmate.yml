name: 16GB Dual VPS (tmate + sshx)

on:
  repository_dispatch:
    types: [create-vps]
  workflow_dispatch:

jobs:
  start-vps:
    runs-on: ubuntu-latest # Ensure repo is PUBLIC for 16GB RAM
    timeout-minutes: 360

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ›‘ Check for Stop Command
        run: |
          if [ -f "STOP_VPS" ]; then
            echo "ðŸ›‘ Stop file detected. Exiting..."
            rm STOP_VPS
            git config --global user.name "VPS-System"
            git config --global user.email "vps@github.com"
            git add STOP_VPS
            git commit -m "Confirmed Stop" && git push || true
            exit 1
          fi

      - name: ðŸ§¹ Maximize Resources
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force

      - name: ðŸ“ Restore Backup
        run: |
          mkdir -p .backup
          if [ "${{ github.event.client_payload.backup }}" == "true" ]; then
            unzip ".backup/autovps.zip" -d . || echo "No backup found."
          fi

      - name: ðŸš€ Start Terminals (tmate & sshx)
        id: access
        run: |
          sudo apt update && sudo apt install -y tmate curl unzip
          
          # Start tmate
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          TMATE_SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          
          # Start sshx
          curl -sSf https://sshx.io/get | sh
          # Run sshx and extract the URL using a temp file
          ./sshx > sshx_log.txt 2>&1 &
          sleep 5
          SSHX_URL=$(grep -o 'https://sshx.io/s/[^ ]*' sshx_log.txt | head -n 1)
          
          echo "TMATE=$TMATE_SSH" >> $GITHUB_ENV
          echo "SSHX=$SSHX_URL" >> $GITHUB_ENV

      - name: ðŸ”” Discord Notification
        run: |
          ACTIONS_URL="https://github.com/${{ github.repository }}/actions"
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "ðŸš€ VPS Online (16GB RAM)",
              "url": "$ACTIONS_URL",
              "description": "Both tmate and sshx terminals are ready.",
              "color": 3066993,
              "fields": [
                {"name": "tmate SSH", "value": "\`$TMATE\`"},
                {"name": "sshx Web Terminal", "value": "$SSHX"},
                {"name": "Management", "value": "[Click here to stop/manage run]($ACTIONS_URL)"}
              ],
              "footer": {"text": "Will auto-restart in 6 hours"}
            }]
          }
          EOF
          )
          curl -H "Content-Type: application/json" -d "$PAYLOAD" ${{ secrets.DISCORD_WEBHOOK }}

      - name: â³ Keep Session Alive
        run: |
          # Runs for 5h 50m to allow time for backup
          sleep 21000

      - name: ðŸ“¦ Auto-Backup before Exit
        if: always()
        run: |
          zip -r ".backup/autovps.zip" . -x ".git/*" ".github/*"
          git config --global user.name "VPS-Backup"
          git config --global user.email "vps@github.com"
          git add .backup/autovps.zip
          git commit -m "Auto-backup session data" || echo "No changes"
          git push
