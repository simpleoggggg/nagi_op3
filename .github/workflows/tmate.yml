name: 16GB Dual VPS (tmate + sshx)

on:
  repository_dispatch:
    types: [create-vps]
  workflow_dispatch:

jobs:
  start-vps:
    runs-on: ubuntu-latest # Ensure repo is PUBLIC to get 16GB RAM
    timeout-minutes: 360

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ›‘ Check for Stop Command
        run: |
          if [ -f "STOP_VPS" ]; then
            echo "ðŸ›‘ Stop file detected. Exiting..."
            rm STOP_VPS
            git config --global user.name "VPS-System"
            git config --global user.email "vps@github.com"
            git add STOP_VPS
            git commit -m "Confirmed Stop" && git push || true
            exit 1
          fi

      - name: ðŸ§¹ Maximize Resources
        run: |
          # Frees up ~2GB RAM and 20GB Disk Space
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force

      - name: ðŸ“ Restore Backup
        run: |
          mkdir -p .backup
          if [ "${{ github.event.client_payload.backup }}" == "true" ]; then
            echo "ðŸ“‚ Restoring previous session data..."
            unzip ".backup/autovps.zip" -d . || echo "âš ï¸ No backup found."
          fi

      - name: ðŸš€ Start Terminals (tmate & sshx)
        id: access
        run: |
          sudo apt update && sudo apt install -y tmate curl unzip
          
          # 1. Setup tmate
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          TMATE_SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          
          # 2. Setup sshx with improved link detection
          curl -sSf https://sshx.io/get | sh
          ./sshx > sshx_log.txt 2>&1 &
          
          echo "â³ Waiting for sshx link to generate..."
          for i in {1..15}; do
            SSHX_URL=$(grep -o 'https://sshx.io/s/[^ ]*' sshx_log.txt | head -n 1)
            if [ -n "$SSHX_URL" ]; then
              echo "âœ… sshx link found!"
              break
            fi
            sleep 2
          done
          
          if [ -z "$SSHX_URL" ]; then SSHX_URL="âš ï¸ Link generation timed out"; fi

          # Save links to environment
          echo "TMATE=$TMATE_SSH" >> $GITHUB_ENV
          echo "SSHX=$SSHX_URL" >> $GITHUB_ENV

      - name: ðŸ”” Discord Notification
        run: |
          ACTIONS_URL="https://github.com/${{ github.repository }}/actions"
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "ðŸš€ VPS Online (16GB RAM / 4-Core)",
              "url": "$ACTIONS_URL",
              "description": "Your VPS has started and is ready for use.",
              "color": 3066993,
              "fields": [
                {"name": "tmate SSH Access", "value": "\`$TMATE\`"},
                {"name": "sshx Web Terminal", "value": "$SSHX"},
                {"name": "Management", "value": "[Go to Actions Page]($ACTIONS_URL)"}
              ],
              "footer": {"text": "Session restarts automatically every 6 hours."}
            }]
          }
          EOF
          )
          curl -H "Content-Type: application/json" -d "$PAYLOAD" ${{ secrets.DISCORD_WEBHOOK }}

      - name: â³ Keep Session Alive
        run: |
          echo "âœ… VPS is running. Connect using the links sent to Discord."
          # Sleep for 5h 50m (21000 seconds) to allow 10 mins for backup
          sleep 21000

      - name: ðŸ“¦ Auto-Backup before Exit
        if: always()
        run: |
          echo "ðŸ“¦ Creating auto-backup..."
          zip -r ".backup/autovps.zip" . -x ".git/*" ".github/*" "sshx_log.txt"
          git config --global user.name "VPS-Backup"
          git config --global user.email "vps@github.com"
          git add .backup/autovps.zip
          git commit -m "Auto-backup session data [skip ci]" || echo "No changes to backup"
          git push
          
