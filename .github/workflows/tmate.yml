name: 16GB Dual VPS Master

on:
  repository_dispatch:
    types: [create-vps]
  workflow_dispatch:

jobs:
  start-vps:
    runs-on: ubuntu-latest # Must be PUBLIC repo for 16GB RAM
    timeout-minutes: 360

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üõë Stop Check
        run: |
          if [ -f "STOP_VPS" ]; then 
            echo "STOP_VPS detected. Exiting..."
            exit 1
          fi

      - name: üßπ Maximize Resources
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force
          sudo apt update && sudo apt install -y tmate curl unzip jq

      - name: üìÅ Restore Backup
        run: |
          mkdir -p .backup
          if [ "${{ github.event.client_payload.backup }}" == "true" ]; then
            unzip -o ".backup/autovps.zip" -d . || echo "No backup found."
          fi

      - name: üöÄ Start Terminals (tmate & sshx)
        id: access
        run: |
          # 1. Setup tmate
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          TMATE_SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          
          # 2. Setup sshx with Aggressive Capture
          curl -sSf https://sshx.io/get | sh
          ./sshx > sshx_log.txt 2>&1 &
          
          echo "‚è≥ Waiting for sshx link..."
          for i in {1..15}; do
            SSHX_URL=$(grep -o 'https://sshx.io/s/[^ ]*' sshx_log.txt | head -n 1)
            if [ -n "$SSHX_URL" ]; then break; fi
            sleep 2
          done
          
          [ -z "$SSHX_URL" ] && SSHX_URL="‚ö†Ô∏è Timeout"

          # Hardware Specs
          RAM=$(free -h | awk '/^Mem:/ {print $2}')
          CPU=$(nproc)

          echo "TMATE=$TMATE_SSH" >> $GITHUB_ENV
          echo "SSHX=$SSHX_URL" >> $GITHUB_ENV
          echo "RAM_TOTAL=$RAM" >> $GITHUB_ENV
          echo "CPU_CORES=$CPU" >> $GITHUB_ENV

      - name: üîî Initial Classic Panel
        run: |
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "SYSTEM CONTROL PANEL",
              "color": 2236962,
              "description": "Virtual Private Server: **Active**",
              "fields": [
                {"name": "üõ∞Ô∏è CONNECTION", "value": "\`$TMATE\`"},
                {"name": "üåê WEB TERMINAL", "value": "[$SSHX]($SSHX)"},
                {"name": "üìä HARDWARE", "value": "RAM: $RAM_TOTAL | CPU: $CPU_CORES Cores"},
                {"name": "üíæ BACKUP", "value": "Run \`pkill sleep\` to save & exit"}
              ],
              "footer": {"text": "BOOT_TIME: $(date '+%Y-%m-%d %H:%M:%S')"}
            }]
          }
          EOF
          )
          RESP=$(curl -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "${{ secrets.DISCORD_WEBHOOK }}?wait=true")
          echo "MSG_ID=$(echo \$RESP | jq -r '.id')" >> $GITHUB_ENV

      - name: ‚è≥ Keep Alive & 1-Min Classic Update
        run: |
          (
            while true; do
              sleep 60
              UPTIME=$(uptime -p | sed 's/up //')
              RAM_USAGE=$(free -m | awk '/Mem:/ {print $3 "MB / " $2 "MB"}')
              LOAD=$(cat /proc/loadavg | awk '{print $1}')

              PAYLOAD=$(cat <<EOF
              {
                "embeds": [{
                  "title": "SYSTEM LIVE STATUS",
                  "color": 2236962,
                  "fields": [
                    {"name": "üõ∞Ô∏è SSH ACCESS", "value": "\`$TMATE\`"},
                    {"name": "üåê WEB LINK", "value": "[$SSHX]($SSHX)"},
                    {"name": "‚è±Ô∏è UPTIME", "value": "$UPTIME", "inline": true},
                    {"name": "üß† RAM LOAD", "value": "$RAM_USAGE", "inline": true},
                    {"name": "üî• CPU LOAD", "value": "$LOAD", "inline": true}
                  ],
                  "footer": {"text": "Last Sync: $(date '+%H:%M:%S') | Auto-Restart in 6h"}
                }]
              }
              EOF
              )
              curl -X PATCH -H "Content-Type: application/json" -d "$PAYLOAD" "${{ secrets.DISCORD_WEBHOOK }}/messages/${{ env.MSG_ID }}"
            done
          ) & 
          sleep 21000

      - name: üì¶ Final Auto-Backup
        if: always()
        run: |
          zip -ru ".backup/autovps.zip" . -x ".git/*" ".github/*" "sshx_log.txt"
          git config --global user.name "VPS-Backup"
          git config --global user.email "vps@github.com"
          git add .backup/autovps.zip
          git commit -m "Auto-backup [skip ci]" || echo "No changes"
          git push --force
          
